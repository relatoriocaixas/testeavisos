<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Avisos Recebedoria</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <button id="adminAccessBtn" class="admin-access">Admin</button>

  <div id="floatingPanel" class="panel">
    <div class="panel-header">
      <div class="title">
        <div>Avisos Recebedoria</div>
        <div id="todayDate" class="date"></div>
      </div>
      <div class="controls">
        <button id="togglePin" title="Fixar/Desfixar">ðŸ“Œ</button>
        <button id="minimize" title="Minimizar">â€”</button>
      </div>
    </div>
    <div id="content" class="panel-body">
      <div id="notices"></div>
    </div>
  </div>

  <!-- Tela de login admin -->
  <div id="loginOverlay" class="login-overlay hidden">
    <div class="login-box">
      <h2>Login Admin</h2>
      <input id="matricula" placeholder="MatrÃ­cula (ex: 6266)" />
      <input id="senha" placeholder="Senha" type="password" />
      <button id="loginAdm">Entrar</button>
      <button id="closeLogin">Fechar</button>
    </div>
  </div>

  <!-- Painel admin -->
  <div id="adminPanel" class="admin-panel hidden">
    <h3>Painel do Administrador</h3>
    <div class="actions">
      <button id="newList">Criar nova lista</button>
      <button id="downloadList">Baixar todas</button>
      <div id="manageLists"></div>
      <button id="logoutAdm">Sair</button>
    </div>
  </div>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyC4mALGbBqJsJp2Xo5twMImq1hHaSV2HuM",
    authDomain: "caixas18-08.firebaseapp.com",
    projectId: "caixas18-08",
    storageBucket: "caixas18-08.firebasestorage.app",
    messagingSenderId: "41940261133",
    appId: "1:41940261133:web:3d2254aafa02608c2df844",
    measurementId: "G-NF5D2RQYSE"
  };
  const ADMINS = ["6266","70029","4144","5354"];
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const $ = (s)=>document.querySelector(s);
  $('#todayDate').textContent = new Date().toLocaleDateString('pt-BR');

  const adminAccessBtn = $('#adminAccessBtn');
  const loginOverlay = $('#loginOverlay');
  const adminPanel = $('#adminPanel');
  const noticesContainer = $('#notices');

  adminAccessBtn.onclick = ()=> loginOverlay.classList.remove('hidden');
  $('#closeLogin').onclick = ()=> loginOverlay.classList.add('hidden');

  let currentAdmin = false;

  $('#loginAdm').onclick = async ()=>{
    const matricula = $('#matricula').value.trim();
    const senha = $('#senha').value;
    const email = matricula + "@movebuss.local";
    if(!ADMINS.includes(matricula)){ alert("MatrÃ­cula nÃ£o Ã© admin"); return; }
    const q = await db.collection("usuarios").where("email","==",email).limit(1).get();
    if(q.empty){ alert("UsuÃ¡rio nÃ£o encontrado"); return; }
    currentAdmin = true;
    loginOverlay.classList.add('hidden');
    adminPanel.classList.remove('hidden');
    renderNotices();
  };

  $('#logoutAdm').onclick = ()=>{
    currentAdmin = false;
    adminPanel.classList.add('hidden');
  };

  $('#newList').onclick = async ()=>{
    const title = prompt("Nome da nova lista:");
    if(!title) return;
    const doc = { title, createdAt: firebase.firestore.FieldValue.serverTimestamp(), items: [] };
    await db.collection("avisos").add(doc);
    renderNotices();
  };

  $('#downloadList').onclick = async ()=>{
    const snap = await db.collection('avisos').get();
    const all = {}; snap.forEach(s=> all[s.id] = s.data());
    const data = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(all,null,2));
    const a = document.createElement('a'); a.href = data; a.download = 'avisos_all.json'; a.click();
  };

  async function renderNotices(){
    noticesContainer.innerHTML = '';
    const snap = await db.collection('avisos').orderBy('createdAt','desc').get();
    if(snap.empty){ noticesContainer.innerHTML='<div class="empty">Sem avisos</div>'; return; }
    snap.forEach(doc=>{
      const d = doc.data();
      const box = document.createElement('div');
      box.className='notice-box';
      box.innerHTML = `<h4>${d.title||'Lista'}</h4>`;
      const list = document.createElement('ul');
      (d.items||[]).forEach((it,idx)=>{
        const li = document.createElement('li');
        li.textContent = it.text;
        if(it.completed) li.classList.add('completed');
        li.onclick = async ()=>{
          if(!currentAdmin) return;
          d.items[idx].completed = !d.items[idx].completed;
          await db.collection('avisos').doc(doc.id).update({items:d.items});
          renderNotices();
        };
        list.appendChild(li);
      });
      box.appendChild(list);
      noticesContainer.appendChild(box);
    });
  }
  renderNotices();
  </script>
</body>
</html>
